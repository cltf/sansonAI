{{define "content"}}
<!-- 技术分享详情页 -->
<div class="tech-share-detail-page">
    <!-- 文章头部信息 -->
    <div class="article-header">
        <div class="article-title-section">
            <h1 class="article-title">{{.article.Title}}</h1>
            <div class="article-meta">
                <div class="author-info">
                    <img src="{{.article.AuthorAvatar}}" alt="{{.article.AuthorName}}" class="author-avatar">
                    <div class="author-details">
                        <div class="author-name">{{.article.AuthorName}}</div>
                        <div class="author-level">Lv.{{.article.AuthorLevel}}</div>
                        <div class="author-bio">{{.article.AuthorBio}}</div>
                    </div>
                </div>
                <div class="article-stats">
                    <div class="publish-time">
                        <i class="fas fa-clock"></i>
                        <span>{{.article.CreatedAt.Format "2006-01-02 15:04"}}</span>
                    </div>
                    <div class="article-category">
                        <i class="fas fa-tag"></i>
                        <span>{{.article.Category}}</span>
                    </div>
                    <div class="article-views">
                        <i class="fas fa-eye"></i>
                        <span>{{.article.ViewCount}} 阅读</span>
                    </div>
                </div>
            </div>
            
            <!-- 标签 -->
            <div class="article-tags">
                {{range .article.TagsArray}}
                <span class="tag">{{.}}</span>
                {{end}}
            </div>
            
            <!-- 操作按钮 -->
            <div class="article-actions">
                <button class="btn-like {{if .article.IsLiked}}liked{{end}}" onclick="likeArticle('{{.article.ID}}')">
                    <i class="fas fa-thumbs-up"></i>
                    <span class="like-count">{{.article.LikeCount}}</span>
                </button>
                <button class="btn-favorite {{if .article.IsFavorited}}favorited{{end}}" onclick="toggleFavorite('{{.article.ID}}')">
                    <i class="fas fa-heart"></i>
                    <span>收藏</span>
                </button>
                <button class="btn-share" onclick="showShareOptions()">
                    <i class="fas fa-share-alt"></i>
                    <span>分享</span>
                </button>
                <button class="btn-report" onclick="reportArticle('{{.article.ID}}')">
                    <i class="fas fa-flag"></i>
                    <span>举报</span>
                </button>
            </div>
        </div>
    </div>

    <!-- 主要内容区域 -->
    <div class="article-main-content">
        <!-- 左侧文章内容 -->
        <main class="article-content-section">
            <article class="article-content">
                <!-- 文章内容 -->
                <div class="content-body">
                    {{.article.Content}}
                </div>
                
                <!-- 文章底部信息 -->
                <div class="article-footer">
                    <div class="article-stats-bottom">
                        <span><i class="fas fa-thumbs-up"></i> {{.article.LikeCount}} 点赞</span>
                        <span><i class="fas fa-comment"></i> {{.article.CommentCount}} 评论</span>
                        <span><i class="fas fa-eye"></i> {{.article.ViewCount}} 阅读</span>
                    </div>
                    <div class="article-tags-bottom">
                        {{range .article.TagsArray}}
                        <span class="tag">{{.}}</span>
                        {{end}}
                    </div>
                </div>
            </article>
            
            <!-- 评论区 -->
            <section class="comments-section">
                <div class="comments-header">
                    <h3>评论 ({{.article.CommentCount}})</h3>
                </div>
                
                <!-- 发表评论 -->
                {{if .user}}
                <div class="comment-form">
                    <div class="comment-input-container">
                        <img src="{{.user.Avatar}}" alt="{{.user.Username}}" class="user-avatar">
                        <div class="comment-input-wrapper">
                            <textarea id="commentContent" placeholder="写下你的评论..." rows="3"></textarea>
                            <div class="comment-actions">
                                <button class="btn-submit-comment" onclick="submitComment()">发表评论</button>
                            </div>
                        </div>
                    </div>
                </div>
                {{else}}
                <div class="comment-login-prompt">
                    <p>请 <a href="/auth/login">登录</a> 后发表评论</p>
                </div>
                {{end}}
                
                <!-- 评论列表 -->
                <div class="comments-list" id="commentsList">
                    {{range .comments}}
                    <div class="comment-item" data-comment-id="{{.ID}}">
                        <div class="comment-avatar">
                            <img src="{{.UserAvatar}}" alt="{{.Username}}">
                        </div>
                        <div class="comment-content">
                            <div class="comment-header">
                                <div class="comment-author">
                                    <span class="author-name">{{.Username}}</span>
                                    <span class="author-level">Lv.{{.UserLevel}}</span>
                                </div>
                                <div class="comment-time">{{.CreatedAt.Format "2006-01-02 15:04"}}</div>
                            </div>
                            <div class="comment-text">{{.Content}}</div>
                            <div class="comment-actions">
                                <button class="btn-like-comment {{if .IsLiked}}liked{{end}}" onclick="likeComment('{{.ID}}')">
                                    <i class="fas fa-thumbs-up"></i>
                                    <span class="like-count">{{.LikeCount}}</span>
                                </button>
                                <button class="btn-reply" onclick="showReplyForm('{{.ID}}')">
                                    <i class="fas fa-reply"></i>
                                    <span>回复</span>
                                </button>
                            </div>
                            
                            <!-- 回复表单 -->
                            <div class="reply-form" id="replyForm{{.ID}}" style="display: none;">
                                <div class="reply-input-container">
                                    <img src="{{$.user.Avatar}}" alt="{{$.user.Username}}" class="user-avatar">
                                    <div class="reply-input-wrapper">
                                        <textarea id="replyContent{{.ID}}" placeholder="回复 @{{.Username}}..." rows="2"></textarea>
                                        <div class="reply-actions">
                                            <button class="btn-submit-reply" onclick="submitReply('{{.ID}}')">回复</button>
                                            <button class="btn-cancel-reply" onclick="hideReplyForm('{{.ID}}')">取消</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 回复列表 -->
                            {{if .Replies}}
                            <div class="replies-list">
                                {{range .Replies}}
                                <div class="reply-item">
                                    <div class="reply-avatar">
                                        <img src="{{.UserAvatar}}" alt="{{.Username}}">
                                    </div>
                                    <div class="reply-content">
                                        <div class="reply-header">
                                            <span class="reply-author">{{.Username}}</span>
                                            <span class="reply-time">{{.CreatedAt.Format "2006-01-02 15:04"}}</span>
                                        </div>
                                        <div class="reply-text">{{.Content}}</div>
                                    </div>
                                </div>
                                {{end}}
                            </div>
                            {{end}}
                        </div>
                    </div>
                    {{end}}
                </div>
            </section>
        </main>
        
        <!-- 右侧边栏 -->
        <aside class="article-sidebar">
            <!-- 文章目录 -->
            <div class="table-of-contents">
                <h4>文章目录</h4>
                <nav class="toc-nav" id="tocNav">
                    <!-- 目录项将通过JavaScript动态生成 -->
                </nav>
            </div>
            
            <!-- 相关文章推荐 -->
            <div class="related-articles">
                <h4>相关文章</h4>
                <div class="related-articles-list">
                    {{range .relatedArticles}}
                    <a href="/tech-share/{{.ID}}" class="related-article-item">
                        <div class="related-article-cover">
                            <img src="{{.CoverImage}}" alt="{{.Title}}">
                        </div>
                        <div class="related-article-info">
                            <h5>{{.Title}}</h5>
                            <div class="related-article-meta">
                                <span class="author">{{.AuthorName}}</span>
                                <span class="views">{{.ViewCount}} 阅读</span>
                            </div>
                        </div>
                    </a>
                    {{end}}
                </div>
            </div>
            
            <!-- 作者其他文章 -->
            <div class="author-articles">
                <h4>作者其他文章</h4>
                <div class="author-articles-list">
                    {{range .authorArticles}}
                    <a href="/tech-share/{{.ID}}" class="author-article-item">
                        <div class="author-article-cover">
                            <img src="{{.CoverImage}}" alt="{{.Title}}">
                        </div>
                        <div class="author-article-info">
                            <h5>{{.Title}}</h5>
                            <div class="author-article-meta">
                                <span class="publish-time">{{.CreatedAt.Format "01-02"}}</span>
                                <span class="views">{{.ViewCount}} 阅读</span>
                            </div>
                        </div>
                    </a>
                    {{end}}
                </div>
            </div>
        </aside>
    </div>
</div>

<!-- 分享选项模态框 -->
<div class="modal" id="shareModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>分享文章</h3>
            <button class="modal-close" onclick="closeShareModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="share-options">
                <button class="share-option" onclick="shareToWeChat()">
                    <i class="fab fa-weixin"></i>
                    <span>微信</span>
                </button>
                <button class="share-option" onclick="shareToWeibo()">
                    <i class="fab fa-weibo"></i>
                    <span>微博</span>
                </button>
                <button class="share-option" onclick="copyLink()">
                    <i class="fas fa-link"></i>
                    <span>复制链接</span>
                </button>
                <button class="share-option" onclick="shareToQQ()">
                    <i class="fab fa-qq"></i>
                    <span>QQ</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 举报模态框 -->
<div class="modal" id="reportModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>举报文章</h3>
            <button class="modal-close" onclick="closeReportModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="report-reasons">
                <label class="report-reason">
                    <input type="radio" name="reportReason" value="spam">
                    <span>垃圾信息</span>
                </label>
                <label class="report-reason">
                    <input type="radio" name="reportReason" value="inappropriate">
                    <span>不当内容</span>
                </label>
                <label class="report-reason">
                    <input type="radio" name="reportReason" value="copyright">
                    <span>版权问题</span>
                </label>
                <label class="report-reason">
                    <input type="radio" name="reportReason" value="other">
                    <span>其他</span>
                </label>
            </div>
            <textarea id="reportDescription" placeholder="请详细描述举报原因..." rows="3"></textarea>
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeReportModal()">取消</button>
                <button class="btn-submit-report" onclick="submitReport()">提交举报</button>
            </div>
        </div>
    </div>
</div>

<script>
// 文章交互功能
function likeArticle(articleId) {
    fetch(`/api/tech-share/${articleId}/like`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const likeBtn = document.querySelector('.btn-like');
            const likeCount = likeBtn.querySelector('.like-count');
            likeCount.textContent = data.likeCount;
            likeBtn.classList.toggle('liked');
        } else {
            alert(data.message || '操作失败');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('网络错误，请稍后重试');
    });
}

function toggleFavorite(articleId) {
    fetch(`/api/tech-share/${articleId}/favorite`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const favoriteBtn = document.querySelector('.btn-favorite');
            favoriteBtn.classList.toggle('favorited');
            const icon = favoriteBtn.querySelector('i');
            const text = favoriteBtn.querySelector('span');
            if (favoriteBtn.classList.contains('favorited')) {
                icon.className = 'fas fa-heart';
                text.textContent = '已收藏';
            } else {
                icon.className = 'far fa-heart';
                text.textContent = '收藏';
            }
        } else {
            alert(data.message || '操作失败');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('网络错误，请稍后重试');
    });
}

function showShareOptions() {
    document.getElementById('shareModal').style.display = 'flex';
}

function closeShareModal() {
    document.getElementById('shareModal').style.display = 'none';
}

function reportArticle(articleId) {
    document.getElementById('reportModal').style.display = 'flex';
    document.getElementById('reportModal').dataset.articleId = articleId;
}

function closeReportModal() {
    document.getElementById('reportModal').style.display = 'none';
}

function submitReport() {
    const articleId = document.getElementById('reportModal').dataset.articleId;
    const reason = document.querySelector('input[name="reportReason"]:checked')?.value;
    const description = document.getElementById('reportDescription').value;
    
    if (!reason) {
        alert('请选择举报原因');
        return;
    }
    
    fetch(`/api/tech-share/${articleId}/report`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            reason: reason,
            description: description
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('举报成功');
            closeReportModal();
        } else {
            alert(data.message || '举报失败');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('网络错误，请稍后重试');
    });
}

// 评论功能
function submitComment() {
    const content = document.getElementById('commentContent').value.trim();
    if (!content) {
        alert('请输入评论内容');
        return;
    }
    
    fetch('/api/tech-share/{{.article.ID}}/comments', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            content: content
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // 刷新页面显示新评论
        } else {
            alert(data.message || '评论失败');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('网络错误，请稍后重试');
    });
}

function likeComment(commentId) {
    fetch(`/api/comments/${commentId}/like`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const likeBtn = document.querySelector(`[data-comment-id="${commentId}"] .btn-like-comment`);
            const likeCount = likeBtn.querySelector('.like-count');
            likeCount.textContent = data.likeCount;
            likeBtn.classList.toggle('liked');
        } else {
            alert(data.message || '操作失败');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('网络错误，请稍后重试');
    });
}

function showReplyForm(commentId) {
    document.getElementById(`replyForm${commentId}`).style.display = 'block';
}

function hideReplyForm(commentId) {
    document.getElementById(`replyForm${commentId}`).style.display = 'none';
}

function submitReply(commentId) {
    const content = document.getElementById(`replyContent${commentId}`).value.trim();
    if (!content) {
        alert('请输入回复内容');
        return;
    }
    
    fetch(`/api/comments/${commentId}/replies`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            content: content
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload(); // 刷新页面显示新回复
        } else {
            alert(data.message || '回复失败');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('网络错误，请稍后重试');
    });
}

// 分享功能
function shareToWeChat() {
    // 实现微信分享逻辑
    alert('微信分享功能开发中...');
}

function shareToWeibo() {
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent('{{.article.Title}}');
    window.open(`https://service.weibo.com/share/share.php?url=${url}&title=${title}`);
}

function shareToQQ() {
    const url = encodeURIComponent(window.location.href);
    const title = encodeURIComponent('{{.article.Title}}');
    window.open(`https://connect.qq.com/widget/shareqq/index.html?url=${url}&title=${title}`);
}

function copyLink() {
    navigator.clipboard.writeText(window.location.href).then(() => {
        alert('链接已复制到剪贴板');
    }).catch(() => {
        // 降级方案
        const textArea = document.createElement('textarea');
        textArea.value = window.location.href;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('链接已复制到剪贴板');
    });
}

// 文章目录生成
function generateTableOfContents() {
    const content = document.querySelector('.content-body');
    const headings = content.querySelectorAll('h1, h2, h3, h4, h5, h6');
    const tocNav = document.getElementById('tocNav');
    
    headings.forEach((heading, index) => {
        // 为标题添加ID
        const id = `heading-${index}`;
        heading.id = id;
        
        // 创建目录项
        const tocItem = document.createElement('a');
        tocItem.href = `#${id}`;
        tocItem.className = `toc-item toc-${heading.tagName.toLowerCase()}`;
        tocItem.textContent = heading.textContent;
        
        tocNav.appendChild(tocItem);
    });
}

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    generateTableOfContents();
    
    // 代码块语法高亮
    const codeBlocks = document.querySelectorAll('pre code');
    codeBlocks.forEach(block => {
        // 添加复制按钮
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-code-btn';
        copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
        copyBtn.onclick = function() {
            navigator.clipboard.writeText(block.textContent).then(() => {
                copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => {
                    copyBtn.innerHTML = '<i class="fas fa-copy"></i>';
                }, 2000);
            });
        };
        block.parentNode.appendChild(copyBtn);
    });
    
    // 平滑滚动
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
});

// 点击模态框外部关闭
window.onclick = function(event) {
    const shareModal = document.getElementById('shareModal');
    const reportModal = document.getElementById('reportModal');
    
    if (event.target === shareModal) {
        closeShareModal();
    }
    if (event.target === reportModal) {
        closeReportModal();
    }
}
</script>
{{end}} 